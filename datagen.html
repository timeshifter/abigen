<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ABI Datagen</title>
    <link rel="stylesheet" href="css/datagen.css">
</head>
<body>
    <div id="nav">
        <header>
            <a href="https://qtum.info" >
                <span class="qtum-icon"></span> qtum.info
            </a>
        </header>
    </div>
    <main class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-header-title">
                    ABI Data Validator
                </div>
            </div>
            <div class="card-body">
                <h3>ABI:</h3>
                <textarea id="txtABI" rows="3" onchange="UpdateABI();" onblur="UpdateABI();">
:name=ExampleABI
arg1:uint8 arg2:uint32[] argUA:uniaddress SimpleFun:fn -> ret1:uint8</textarea>
                <p id="abi_feedback"></p>
                <h3>Data:</h3>
                <p class="info">Paste a data string here to validate and encode.</p>
                <div id="data_container">
                    <textarea id="txtData" spellcheck="false" oninput="UpdateData();" onblur="UpdateData();">
{
    arg1: 0x20
    arg2: [0x11223344, 0xdeadbeef, 0xffeeddcc]
    argUA: Qbf6sk8kydFLnikXGkSxKLcczNBwVgWwrR
    _function: SimpleFun
}</textarea>
                <ul id="data_params">
                </ul>
                </div>
                <h3>Output data block</h3>
                <p id="output_data"></p>   

            </div>
         
        </div>


    </main>

    <script src="datagen.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script>

        var param_template =
`            <li>
                <input type="text" class="arg" />
                <select>
                    <option>uint8</option>
                    <option>uint16</option>
                    <option>uint32</option>
                    <option>uint64</option>
                    <option>int8</option>
                    <option>int16</option>
                    <option>int32</option>
                    <option>int64</option>
                    <option>uint8[]</option>
                    <option>uint16[]</option>
                    <option>uint32[]</option>
                    <option>uint64[]</option>
                    <option>int8[]</option>
                    <option>int16[]</option>
                    <option>int32[]</option>
                    <option>int64[]</option>
                    <option value="fn">_function</option>
                    <option>uniaddress</option>
                </select>
                <input type="text" class="param_val" />
                <p class="encoded"></p>
            </li>`;

		var abi, data;

        $(function() {
            UpdateABI();
        });



        function UpdateABI() {
			console.log('abi update');
            $('#abi_feedback').html('');
            try{
                abi = ABIdatagen.ParseContract(txtABI.value);
            }
            catch(e){
                $('#abi_feedback').html(e);
                return;
            }
			UpdateData();
            
        }

        function UpdateData() {

			if(txtData.scrollHeight > txtData.clientHeight){
				txtData.style["height"] = (txtData.scrollHeight + 2) + 'px';
			}

			if (abi == undefined) {
				try {
					abi = ABIdatagen.ParseContract(txtABI.value);
				}
				catch (e) {
					$('#abi_feedback').html(e);
					return;
				}
			}
                
            data = ABIdatagen.ParseData(txtData.value);
            //console.log(abi);
			//console.log(data);
			
			var lines = txtData.value.split('\n');
			//console.log(lines);

			var ul_output='', idx=0;
			for(l of lines){
				l=l.trim();
				var isError=false, msg='';
				if(l=='' || l=='{' || l=='}'){
					
				}
				else {
					var parts = l.split(':'), t='';

					for(i of abi.InputParams){
						if((parts[0].trim()==i.Val)
							|| (parts[0].trim() == '_function' && parts[1].trim() == i.Val))
						{
							t=i.Type;
							break;
						}
					}

					if(t==''){
						isError=true;
						if(parts[0].trim().indexOf('_')==0){
							if(parts[0].trim()!='_function') {
								msg="Unknown identifier '" + parts[0].trim() + "'.";
							}
							else{
								msg = `Input function with name '${parts[1].trim()}' not found in ABI.`;
							}
						}
						else{
							msg=`Input argument with name '${parts[0].trim()}' not found in ABI.`;
						}
					}
					else{
						try{
							if(t=='fn'){
								msg=ABIdatagen.GetFunctionID(abi);
							}
							else if(t=='uniaddress'){
								msg = ABIdatagen.EncodeUA(parts[1].trim());
							}
							else{
								msg = ABIdatagen.EncodeValue(t, parts[1].trim());
							}
						}
						catch(e){
							isError=true;
							msg=e;
						}
						
					}

				}

				ul_output+=`<li${isError? ' class="error"' : ''} style="top:${1.2 + (idx*2.5)}em">${msg}</li>`;
				idx++;
			}

			$('#data_params').html(ul_output);

            
            try{
                $('#output_data').html(ABIdatagen.GetData(txtABI.value, txtData.value));
            }
            catch(e) {
                $('#output_data').html(e);
            }
        }
        
    </script>
</body>
</html>